<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RIMT Smart Attendance - Complete Teacher Dashboard</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    .header { text-align: center; color: white; margin-bottom: 10px; font-size: 2.5em; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    .tagline { text-align: center; color: #fff; font-size: 1.4em; font-weight: 500; margin-top: 10px; opacity: 0; transform: translateY(20px); animation: fadeSlideIn 1s forwards; text-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    @keyframes fadeSlideIn { to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 768px) { .tagline { font-size: 1.1em; } }
    .tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
    .tab-btn { flex: 1; min-width: 150px; padding: 15px; background: rgba(255,255,255,0.2); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s; }
    .tab-btn.active { background: rgba(255,255,255,0.9); color: #333; }
    .tab-btn:hover { transform: translateY(-2px); }
    .panel { display: none; background: rgba(255,255,255,0.95); border-radius: 20px; padding: 30px; backdrop-filter: blur(20px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
    .panel.active { display: block; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
    input, button { width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 12px; font-size: 16px; transition: all 0.3s; }
    input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
    button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; font-weight: 600; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
    button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102,126,234,0.3); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .status { padding: 15px; border-radius: 12px; margin: 20px 0; font-weight: 600; text-align: center; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .live-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .live-table th, .live-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    .live-table th { background: #f8f9fa; font-weight: 600; color: #333; }
    .live-table tr:hover { background: #f8f9fa; }
    .code-display { background: white; padding: 30px; border-radius: 16px; text-align: center; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .session-code { font-size: 3em; font-weight: bold; color: #667eea; letter-spacing: 5px; margin: 10px 0; }
    .copy-btn { background: #28a745; padding: 10px 20px; font-size: 14px; margin-top: 15px; width: auto; }
    .end-session-btn { background: #dc3545 !important; color: white; padding: 15px 30px !important; margin: 15px 0 !important; font-size: 16px !important; width: auto !important; }
    .end-session-btn:hover:not(:disabled) { background: #c82333 !important; transform: translateY(-2px); }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
    .stat-card { background: white; padding: 25px; border-radius: 16px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.3s; }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-number { font-size: 2.5em; font-weight: bold; color: #667eea; }
    .stat-label { color: #666; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
    .subject-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
    .subject-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .subject-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
    .subject-name { font-size: 1.3em; font-weight: 600; color: #333; }
    .count-badge { background: #667eea; color: white; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 14px; }
    .teacher-tabs { display: flex; gap: 10px; margin-bottom: 25px; background: white; padding: 15px; border-radius: 12px; flex-wrap: wrap; }
    .teacher-tab-btn { flex: 1; min-width: 140px; padding: 12px; background: #f8f9fa; border: none; border-radius: 8px; color: #333; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .teacher-tab-btn.active { background: #667eea; color: white; }
    .filter-row { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
    .filter-row input { flex: 1; min-width: 200px; }
    .filter-row button { padding: 12px 24px; white-space: nowrap; }
    .summary-stats { margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 12px; font-weight: 600; }
    .footer { margin-top: 40px; text-align: center; color: rgba(255,255,255,0.85); font-size: 14px; font-weight: 600; letter-spacing: 0.5px; }
    @media (max-width: 768px) {
        .tabs, .teacher-tabs, .filter-row { flex-direction: column; }
        .stats-grid, .subject-grid { grid-template-columns: 1fr; }
        .session-code { font-size: 2em; }
        .live-table { font-size: 14px; }
        .live-table thead { display: none; }
        .live-table tr { display: block; margin-bottom: 15px; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .live-table td { display: block; text-align: right; padding: 5px 0; position: relative; }
        .live-table td:before { content: attr(data-label); float: left; font-weight: 600; color: #666; }
    }
</style>
</head>
<body>
<div class="container">
    <h1 class="header">RIMT Smart Attendance</h1>
    <h2 class="tagline">Smarter Classrooms, Happier Teachers</h2>
    
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('teacher', this)">üë®‚Äçüè´ Teacher Panel</button>
        <button class="tab-btn" onclick="switchTab('student', this)">üéì Student Panel</button>
        <button class="tab-btn" onclick="switchTab('live', this)">üìä Live View</button>
    </div>

    <!-- TEACHER PANEL -->
    <div id="teacher-panel" class="panel active">
        <div class="form-group">
            <label>üë§ Username</label>
            <input type="text" id="t-username" placeholder="admin">
        </div>
        <div class="form-group">
            <label>üîí Password</label>
            <input type="password" id="t-password" placeholder="Enter password">
        </div>
        <button onclick="teacherLogin()" id="login-btn">üöÄ Login</button>
        <div id="login-status"></div>

        <div id="teacher-content" style="display: none;">
            <!-- TEACHER SUB-TABS -->
            <div class="teacher-tabs">
                <button class="teacher-tab-btn active" onclick="showTeacherSection('live', this)">üìä Live Session</button>
                <button class="teacher-tab-btn" onclick="showTeacherSection('all', this)">üìà All Records</button>
                <button class="teacher-tab-btn" onclick="showTeacherSection('export', this)">üì• Export Data</button>
            </div>

            <!-- LIVE SESSION SECTION -->
            <div id="teacher-live-section">
                <div class="form-group">
                    <label>üìö Subject</label>
                    <input type="text" id="t-subject" placeholder="e.g. Mathematics">
                </div>
                <button onclick="generateCode()" id="generate-btn">üé´ Generate Session Code</button>

                <div id="code-display" style="display: none;">
                    <div class="code-display">
                        <h3>üì≤ Session Code</h3>
                        <div class="session-code" id="session-code"></div>
                        <p style="color: #666; font-size: 18px;">Share this 6-digit code with students<br><small>üìç Location-based (40m radius) - Active Session</small></p>
                        <button class="copy-btn" onclick="copyCode()">üìã Copy Code</button>
                    </div>
                </div>

                <!-- END SESSION BUTTON -->
                <button id="end-session-btn" onclick="endSession()" class="end-session-btn" style="display:none;">
                    üõë End Live Session
                </button>

                <div class="stats-grid" id="teacher-stats" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-number" id="total-present">-</div>
                        <div class="stat-label">Total Present</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="on-time">-</div>
                        <div class="stat-label">On Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="unique-devices">-</div>
                        <div class="stat-label">Unique Devices</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avg-distance">-</div>
                        <div class="stat-label">Avg Distance (m)</div>
                    </div>
                </div>

                <div id="teacher-live">
                    <h3>üìà Live Attendance Dashboard</h3>
                    <div id="teacher-live-data" class="subject-grid"></div>
                </div>
            </div>

            <!-- ALL RECORDS SECTION -->
            <div id="teacher-all-section" style="display: none;">
                <h3>üìã Complete Attendance Records</h3>
                <div class="filter-row">
                    <input type="date" id="date-filter">
                    <input type="text" id="subject-filter" placeholder="Filter by subject...">
                    <input type="text" id="roll-filter" placeholder="Filter by roll number...">
                    <button onclick="loadAllAttendance()" style="background:#28a745;">üîÑ Load Records</button>
                </div>
                <div id="all-attendance-table">
                    <table class="live-table">
                        <thead>
                            <tr style="background:#667eea; color:white;">
                                <th>Name</th><th>Roll</th><th>Subject</th><th>Session</th><th>Time</th><th>Status</th><th>Distance</th>
                            </tr>
                        </thead>
                        <tbody id="all-tbody">
                            <tr><td colspan="7">Click "Load Records" to view all data</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="summary-stats" class="summary-stats" style="display:none;">
                    <strong>Total Records: <span id="total-records">0</span> | 
                    Unique Students: <span id="unique-students">0</span> | 
                    Sessions: <span id="total-sessions">0</span> | 
                    Date Range: <span id="date-range">-</span></strong>
                </div>
            </div>

            <!-- EXPORT SECTION -->
            <div id="teacher-export-section" style="display: none;">
                <h3>üì• Student Attendance Reports</h3>
                <div class="filter-row">
                    <input type="date" id="export-date-from">
                    <input type="date" id="export-date-to">
                    <button onclick="exportFilteredData()" class="copy-btn" style="background:#28a745;">üìÖ Date Range Report</button>
                    <button onclick="exportSummaryReport()" class="copy-btn" style="background:#007bff;">üìä Complete Summary</button>
                </div>
                <div style="background:#f8f9fa; padding:15px; border-radius:12px; margin-top:20px;">
                    <strong>‚úÖ Features:</strong> Student-wise summary | Attendance % | Avg distance | All sessions listed
                </div>
                <p style="color:#666; margin-top:20px;">üì± Perfect for Excel/Google Sheets analysis ‚úì</p>
            </div>
        </div>
    </div>

    <!-- STUDENT PANEL -->
    <div id="student-panel" class="panel">
        <div class="form-group">
            <label>üë§ Full Name</label>
            <input type="text" id="s-name" placeholder="Enter your full name">
        </div>
        <div class="form-group">
            <label>üé´ Roll Number</label>
            <input type="text" id="s-roll" placeholder="e.g. 25BCA001">
        </div>
        <div class="form-group">
            <label>üìö Subject</label>
            <input type="text" id="s-subject" placeholder="e.g. Mathematics">
        </div>
        <div class="form-group">
            <label>üî¢ Session Code</label>
            <input type="text" id="s-code" placeholder="6-digit code from teacher">
        </div>
        <button onclick="markAttendance()" id="attendance-btn">‚úÖ Mark My Attendance</button>
        <div id="attendance-status"></div>
    </div>

    <!-- LIVE VIEW PANEL -->
    <div id="live-panel" class="panel">
        <div class="form-group">
            <label>üìö Subject</label>
            <input type="text" id="l-subject" placeholder="e.g. Mathematics">
        </div>
        <div class="form-group">
            <label>üî¢ Session Code</label>
            <input type="text" id="l-code" placeholder="6-digit code">
        </div>
        <button onclick="loadLiveAttendance()">üîÑ Refresh Live Data</button>
        <div id="live-table-container">
            <table class="live-table" id="live-table">
                <thead>
                    <tr><th>Name</th><th>Roll</th><th>Time</th><th>Status</th><th>Distance</th><th>Device</th></tr>
                </thead>
                <tbody id="live-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script>
    // üî• YOUR FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyCMpPODrwHBc-0e0sWFKUaggZNK8RGXL7w",
        authDomain: "rimt-smart-attendance-767ad.firebaseapp.com",
        projectId: "rimt-smart-attendance-767ad",
        storageBucket: "rimt-smart-attendance-767ad.firebasestorage.app",
        messagingSenderId: "158157431900",
        appId: "1:158157431900:web:f9651d76d2b1c67ff17299"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    console.log('‚úÖ Firebase initialized successfully!');

    const deviceId = btoa(navigator.userAgent + screen.width + screen.height + Date.now()).substring(0,32);
    let currentSessionCode = '';
    let currentTeacherSection = 'live';
    let teacherLoggedIn = false;

    // ================= DISTANCE CALCULATION =================
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000; // Earth radius in meters
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // MAIN TAB SWITCHING
    function switchTab(tab, button) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tab+'-panel').classList.add('active');
        button.classList.add('active');
    }

    // TEACHER LOGIN
    function teacherLogin(){
        const user = document.getElementById('t-username').value.trim();
        const pass = document.getElementById('t-password').value;
        const status = document.getElementById('login-status');
        const btn = document.getElementById('login-btn');

        if(!user || !pass){ 
            status.innerHTML = '<div class="status error">‚ùå Enter credentials</div>'; 
            return; 
        }
        btn.disabled = true; btn.textContent='Logging in...';

        if(user==='admin' && pass==='admin123'){
            status.innerHTML='<div class="status success">‚úÖ Login Successful! Welcome to RIMT Dashboard</div>';
            document.getElementById('teacher-content').style.display='block';
            btn.style.display='none';
            teacherLoggedIn = true;
        } else {
            status.innerHTML='<div class="status error">‚ùå Invalid credentials</div>';
        }
        btn.disabled=false; btn.textContent='üöÄ Login';
    }

    // TEACHER SUB-TABS
    function showTeacherSection(section, button) {
        currentTeacherSection = section;
        document.querySelectorAll('#teacher-content > div[id$="-section"]').forEach(div => div.style.display = 'none');
        document.querySelectorAll('.teacher-tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('teacher-' + section + '-section').style.display = 'block';
        button.classList.add('active');
        
        if(section === 'all') loadAllAttendance();
        if(section === 'live' && currentSessionCode) {
            loadTeacherLive();
            loadTeacherStats();
        }
    }

    // ================= TEACHER: GENERATE SESSION WITH LOCATION =================
    async function generateCode(){
        const subject = document.getElementById('t-subject').value.trim();
        if(!subject){ alert('Enter subject first!'); return; }

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const code = Math.floor(100000 + Math.random()*900000).toString();
            currentSessionCode = code;
            document.getElementById('session-code').textContent = code;
            document.getElementById('code-display').style.display='block';
            document.getElementById('end-session-btn').style.display='block';
            document.getElementById('teacher-stats').style.display='grid';

            try {
                await db.collection('sessions').doc(code).set({ 
                    subject, code, 
                    teacherLat: pos.coords.latitude,
                    teacherLng: pos.coords.longitude,
                    radius: 40,
                    createdAt: Date.now(), 
                    endedAt: null,
                    isActive: true 
                });
                console.log('‚úÖ Geo-fenced session created:', code);
                loadTeacherLive();
                loadTeacherStats();
            } catch(e) {
                console.error('‚ùå Generate code error:', e);
                alert('Error: Check Firebase rules - ' + e.message);
            }
        }, (error) => {
            alert('‚ùå Location permission required for teacher location!');
            console.error('Geolocation error:', error);
        });
    }

    // ================= TEACHER: END SESSION =================
    async function endSession() {
        if(!currentSessionCode) return;

        const confirmEnd = confirm("üõë Are you sure you want to end this session?\nNo more students can mark attendance after this.");
        if(!confirmEnd) return;

        try {
            await db.collection('sessions').doc(currentSessionCode).update({
                isActive: false,
                endedAt: Date.now()
            });
            alert("‚úÖ Session ended successfully!");
            document.getElementById('end-session-btn').disabled = true;
            document.getElementById('end-session-btn').innerText = "üö´ Session Ended";
        } catch(e) {
            console.error('‚ùå End session error:', e);
            alert('Error ending session: ' + e.message);
        }
    }

    function copyCode(){ 
        navigator.clipboard.writeText(currentSessionCode).then(()=>{
            alert('‚úÖ Code copied to clipboard!');
        }); 
    }

    // ================= STUDENT: MARK ATTENDANCE WITH DISTANCE CHECK =================
    async function markAttendance(){
        const name=document.getElementById('s-name').value.trim();
        const roll=document.getElementById('s-roll').value.trim();
        const subject=document.getElementById('s-subject').value.trim();
        const code=document.getElementById('s-code').value.trim();
        const statusDiv=document.getElementById('attendance-status');
        const btn=document.getElementById('attendance-btn');

        if(!name||!roll||!subject||!code){ 
            statusDiv.innerHTML='<div class="status error">‚ùå Fill all fields</div>'; 
            return; 
        }
        btn.disabled=true; btn.textContent='Checking location...'; statusDiv.innerHTML='';

        try {
            const sessionSnap = await db.collection('sessions').doc(code).get();
            if(!sessionSnap.exists){
                statusDiv.innerHTML='<div class="status error">‚ùå Invalid session code</div>';
                return;
            }

            const session = sessionSnap.data();
            if(!session.isActive){
                statusDiv.innerHTML='<div class="status error">‚ùå Session closed by teacher</div>';
                return;
            }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const distance = getDistance(
                    session.teacherLat,
                    session.teacherLng,
                    pos.coords.latitude,
                    pos.coords.longitude
                );

                if(distance > session.radius){
                    statusDiv.innerHTML=`<div class="status error">‚ùå Outside classroom (${Math.round(distance)}m)<br>Max allowed: ${session.radius}m</div>`;
                    btn.disabled=false; btn.textContent='‚úÖ Mark My Attendance';
                    return;
                }

                await db.collection('attendance').add({ 
                    name, roll, subject, code, device: deviceId, 
                    status:'Present', timestamp: Date.now(),
                    distance: Math.round(distance)
                });
                statusDiv.innerHTML=`<div class="status success">‚úÖ Attendance marked! (${Math.round(distance)}m)</div>`;
                
                document.getElementById('s-name').value=''; 
                document.getElementById('s-roll').value='';
                document.getElementById('s-subject').value=''; 
                document.getElementById('s-code').value='';
                
            }, (error) => {
                statusDiv.innerHTML='<div class="status error">‚ùå Location permission denied</div>';
                console.error('Geolocation error:', error);
            });

        } catch(e){
            console.error('‚ùå Mark attendance error:', e);
            statusDiv.innerHTML=`<div class="status error">‚ùå Error: ${e.message}</div>`;
        }
        btn.disabled=false; btn.textContent='‚úÖ Mark My Attendance';
    }

    // LIVE ATTENDANCE VIEW
    function loadLiveAttendance(){
        const subject=document.getElementById('l-subject').value.trim();
        const code=document.getElementById('l-code').value.trim();
        const tbody=document.getElementById('live-tbody'); 
        tbody.innerHTML='';

        if(!subject||!code){ 
            alert('Enter subject and code'); 
            return; 
        }

        db.collection('attendance')
        .where('subject','==',subject)
        .where('code','==',code)
        .orderBy('timestamp', 'desc')
        .onSnapshot(snapshot=>{
            tbody.innerHTML='';
            let count = 0;
            snapshot.forEach(doc=>{
                count++;
                const d=doc.data();
                const tr=document.createElement('tr');
                tr.innerHTML=`<td data-label="Name">${d.name}</td><td data-label="Roll">${d.roll}</td><td data-label="Time">${new Date(d.timestamp).toLocaleTimeString()}</td><td data-label="Status">${d.status}</td><td data-label="Distance">${d.distance || '-'}m</td><td data-label="Device">${d.device.substring(0,8)}...</td>`;
                tbody.appendChild(tr);
            });
            if(count === 0) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No attendance data yet</td></tr>';
        });
    }

    // TEACHER LIVE DASHBOARD
    function loadTeacherLive(){
        if(!currentSessionCode) return;
        const container=document.getElementById('teacher-live-data'); 
        container.innerHTML='<div style="text-align:center;padding:20px;">üîÑ Loading live data...</div>';
        
        db.collection('attendance')
        .where('code','==',currentSessionCode)
        .orderBy('timestamp', 'desc')
        .onSnapshot(snapshot=>{
            const students=snapshot.docs.map(d=>d.data());
            container.innerHTML='';
            if(students.length===0){ 
                container.innerHTML='<div class="subject-card" style="text-align:center;padding:40px;"><p>üì± No students marked attendance yet<br><small>Share the session code with your class</small></p></div>'; 
                return; 
            }
            const card=document.createElement('div'); 
            card.className='subject-card';
            card.innerHTML=`<div class="subject-header">
                <div class="subject-name">üìä Live Attendance (${students.length})</div>
                <div class="count-badge">${students.length} students</div>
            </div>
            <div style="max-height:300px; overflow-y:auto;">
                ${students.map(s=>`
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f0f0f0;">
                        <span style="font-weight:500;">${s.name}</span>
                        <span style="font-size:13px; color:#666;">
                            ${s.roll} ‚Ä¢ ${s.status} ‚Ä¢ 
                            <span style="color:#28a745;">${s.distance || '-'}m</span> ‚Ä¢ 
                            <span style="font-size:11px;">${s.device.substring(0,8)}...</span>
                        </span>
                    </div>
                `).join('')}
            </div>`;
            container.appendChild(card);
        });
    }

    // TEACHER STATS
    async function loadTeacherStats(){
        if(!currentSessionCode) return;
        try {
            const snapshot=await db.collection('attendance')
                .where('code','==',currentSessionCode).get();
            const stats={totalPresent:0, onTime:0, uniqueDevices:new Set(), totalDistance:0};
            snapshot.forEach(doc=>{
                const d=doc.data();
                stats.totalPresent++; 
                stats.onTime++; 
                stats.uniqueDevices.add(d.device);
                if(d.distance) stats.totalDistance += d.distance;
            });
            document.getElementById('total-present').textContent=stats.totalPresent;
            document.getElementById('on-time').textContent=stats.onTime;
            document.getElementById('unique-devices').textContent=stats.uniqueDevices.size;
            document.getElementById('avg-distance').textContent=stats.totalPresent ? Math.round(stats.totalDistance/stats.totalPresent) : 0;
        } catch(e) {
            console.error('‚ùå Stats error:', e);
        }
    }

    // ALL RECORDS
    async function loadAllAttendance() {
        const tbody = document.getElementById('all-tbody');
        const dateFilter = document.getElementById('date-filter').value;
        const subjectFilter = document.getElementById('subject-filter').value.toLowerCase();
        const rollFilter = document.getElementById('roll-filter').value.toLowerCase();
        
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">üîÑ Loading all records...</td></tr>';
        
        try {
            let query = db.collection('attendance').orderBy('timestamp', 'desc').limit(1000);
            
            if(dateFilter) {
                const start = new Date(dateFilter + 'T00:00:00').getTime();
                const end = new Date(dateFilter + 'T23:59:59').getTime();
                query = query.where('timestamp', '>=', start).where('timestamp', '<=', end);
            }
            
            const snapshot = await query.get();
            const records = snapshot.docs.map(doc => doc.data());
            
            const filteredRecords = records.filter(r => 
                (!subjectFilter || r.subject.toLowerCase().includes(subjectFilter)) &&
                (!rollFilter || r.roll.toLowerCase().includes(rollFilter))
            );
            
            tbody.innerHTML = '';
            const uniqueStudents = new Set();
            const uniqueSessions = new Set();
            
            filteredRecords.forEach(record => {
                uniqueStudents.add(record.roll);
                uniqueSessions.add(record.code);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="Name">${record.name}</td>
                    <td data-label="Roll">${record.roll}</td>
                    <td data-label="Subject">${record.subject}</td>
                    <td data-label="Session">${record.code}</td>
                    <td data-label="Time">${new Date(record.timestamp).toLocaleString()}</td>
                    <td data-label="Status"><span style="color:#28a745; font-weight:bold;">${record.status || 'Present'}</span></td>
                    <td data-label="Distance">${record.distance || '-'}m</td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('total-records').textContent = filteredRecords.length;
            document.getElementById('unique-students').textContent = uniqueStudents.size;
            document.getElementById('total-sessions').textContent = uniqueSessions.size;
            document.getElementById('date-range').textContent = dateFilter ? new Date(dateFilter).toLocaleDateString() : 'All Time';
            document.getElementById('summary-stats').style.display = 'block';
            
        } catch(e) {
            console.error('‚ùå Load all error:', e);
            tbody.innerHTML = '<tr><td colspan="7" style="color:red; text-align:center;">Error loading data - Check console</td></tr>';
        }
    }

    // EXPORT FUNCTIONS
    async function exportFilteredData() {
        const dateFrom = document.getElementById('export-date-from').value;
        const dateTo = document.getElementById('export-date-to').value;
        
        try {
            let query = db.collection('attendance').orderBy('timestamp', 'desc');
            
            if(dateFrom) {
                const start = new Date(dateFrom + 'T00:00:00').getTime();
                query = query.where('timestamp', '>=', start);
            }
            if(dateTo) {
                const end = new Date(dateTo + 'T23:59:59').getTime();
                query = query.where('timestamp', '<=', end);
            }
            
            const snapshot = await query.get();
            const allRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const studentReports = groupByStudent(allRecords);
            const csv = generateStudentReportCSV(studentReports);
            downloadCSV(csv, `RIMT_Student_Attendance_Report_${getFormattedDate()}.csv`);
            
        } catch(e) {
            console.error('Export error:', e);
            alert('Export failed: ' + e.message);
        }
    }

    function exportSummaryReport() {
        document.getElementById('export-date-from').value = '';
        document.getElementById('export-date-to').value = '';
        exportFilteredData();
    }

    function groupByStudent(records) {
        const studentMap = {};
        records.forEach(record => {
            const studentKey = `${record.roll}_${record.name}`.trim();
            if (!studentMap[studentKey]) {
                studentMap[studentKey] = {
                    roll: record.roll,
                    name: record.name.trim(),
                    totalAttendance: 0,
                    sessions: new Set(),
                    subjects: new Set(),
                    onTime: 0,
                    avgDistance: 0,
                    totalDistance: 0,
                    records: []
                };
            }
            const student = studentMap[studentKey];
            student.totalAttendance++;
            student.sessions.add(record.code);
            student.subjects.add(record.subject);
            student.records.push(record);
            if (record.distance) {
                student.totalDistance += record.distance;
                student.avgDistance = student.totalDistance / student.totalAttendance;
            }
        });
        return Object.values(studentMap).sort((a, b) => a.roll.localeCompare(b.roll));
    }

    function generateStudentReportCSV(students) {
        let csv = '';
        csv += `RIMT UNIVERSITY - SMART ATTENDANCE REPORT\n`;
        csv += `Generated: ${new Date().toLocaleString('en-IN')}\n`;
        csv += `Total Students: ${students.length}\n`;
        csv += `Total Attendance Records: ${students.reduce((sum, s) => sum + s.totalAttendance, 0)}\n\n`;
        csv += `Roll Number,Student Name,Total Classes Attended,Unique Sessions,Unique Subjects,Attendance Rate,Average Distance (m),Detailed Records\n`;
        
        students.forEach(student => {
            const attendanceRate = ((student.totalAttendance / student.sessions.size) * 100).toFixed(1);
            const recordsCSV = student.records.map(r => 
                `"${r.subject}|${r.code}|${new Date(r.timestamp).toLocaleString('en-IN')}|${r.distance || 'N/A'}m|${r.device?.substring(0,8)}..."`
            ).join('; ');
            csv += `"${student.roll}","${student.name}","${student.totalAttendance}","${student.sessions.size}","${student.subjects.size}","${attendanceRate}%","${Math.round(student.avgDistance)}","${recordsCSV}"\n`;
        });
        return csv;
    }

    function downloadCSV(csvContent, filename) {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function getFormattedDate() {
        return new Date().toISOString().split('T')[0];
    }

    // AUTO REFRESH
    setInterval(()=>{
        if(currentSessionCode && teacherLoggedIn && currentTeacherSection === 'live') { 
            loadTeacherLive(); 
            loadTeacherStats(); 
        }
    },3000);

    console.log('üöÄ RIMT Smart Attendance - Ready!');
</script>

<div class="footer">POWERED BY CODEVERSE ‚Äì RIMT UNIVERSITY </div>
</body>
</html>
